name: n8n CI/CD Pipeline

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      promote_to_prod:
        description: 'Promote to Production'
        required: true
        type: boolean
        default: false
      skip_backup:
        description: 'Skip pre-deployment backup'
        required: false
        type: boolean
        default: false

env:
  DEV_VPS_HOST: '194.238.17.118'
  PROD_VPS_HOST: '72.61.226.144'
  DEV_VPS_USER: 'root'
  PROD_VPS_USER: 'root'
  SSH_KEY_PATH: '/tmp/deploy_key'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    if: github.event.inputs.promote_to_prod == 'true' || github.event_name == 'push'
    
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ${SSH_KEY_PATH}
          chmod 600 ${SSH_KEY_PATH}
          ssh-keyscan -H ${{ env.DEV_VPS_HOST }} >> ~/.ssh/known_hosts
          ssh-keyscan -H ${{ env.PROD_VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Trigger export on DEV
        run: |
          ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${{ env.DEV_VPS_USER }}@${{ env.DEV_VPS_HOST }} << 'ENDSSH'
            set -e
            chmod +x /srv/n8n/scripts/export_from_dev.sh
            /srv/n8n/scripts/export_from_dev.sh
            echo "‚úì Export completed on DEV"
          ENDSSH

      - name: Fetch latest package path from DEV
        id: fetch_latest
        run: |
          LATEST_PACKAGE=$(ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${{ env.DEV_VPS_USER }}@${{ env.DEV_VPS_HOST }} "ls -t /srv/n8n/migration-temp/n8n_export_*.tar.gz 2>/dev/null | head -n1")
          if [ -z "$LATEST_PACKAGE" ]; then
            echo "No export package found on DEV. Please run export script manually."
            exit 1
          fi
          echo "package_path=$LATEST_PACKAGE" >> $GITHUB_OUTPUT
          echo "package_name=$(basename $LATEST_PACKAGE)" >> $GITHUB_OUTPUT

      - name: Copy package from DEV to PROD
        run: |
          PACKAGE_PATH="${{ steps.fetch_latest.outputs.package_path }}"
          PACKAGE_NAME="${{ steps.fetch_latest.outputs.package_name }}"
          echo "Copying $PACKAGE_NAME from DEV to PROD..."
          # Ensure destination directory exists on PROD
          ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${{ env.PROD_VPS_USER }}@${{ env.PROD_VPS_HOST }} "mkdir -p /srv/n8n/migration-temp"
          scp -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no "${{ env.DEV_VPS_USER }}@${{ env.DEV_VPS_HOST }}:${PACKAGE_PATH}" "${{ env.PROD_VPS_USER }}@${{ env.PROD_VPS_HOST }}:/srv/n8n/migration-temp/${PACKAGE_NAME}"

      - name: Trigger import on PROD
        run: |
          PACKAGE_NAME="${{ steps.fetch_latest.outputs.package_name }}"
          ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${{ env.PROD_VPS_USER }}@${{ env.PROD_VPS_HOST }} << "ENDSSH"
            set -e
            PACKAGE_NAME="${PACKAGE_NAME}"
            chmod +x /srv/n8n/scripts/import_to_prod.sh
            
            # Skip backup if requested
            SKIP_BACKUP="${{ github.event.inputs.skip_backup }}"
            if [ "$SKIP_BACKUP" != "true" ]; then
              if [ -f /srv/n8n/scripts/backup.sh ]; then
                chmod +x /srv/n8n/scripts/backup.sh
                /srv/n8n/scripts/backup.sh || echo "‚ö† Backup failed, continuing..."
              fi
            fi
            
            # Run import script with package path (already copied)
            /srv/n8n/scripts/import_to_prod.sh /srv/n8n/migration-temp/${PACKAGE_NAME}
            
            echo "‚úì Import completed on PROD"
          ENDSSH

      - name: Verify deployment
        run: |
          ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=no ${{ env.PROD_VPS_USER }}@${{ env.PROD_VPS_HOST }} << 'ENDSSH'
            # Detect n8n container
            N8N_CONTAINER=$(docker ps --format '{{.Names}}' | grep -iE 'n8n' | grep -vE 'postgres|db' | head -n1)
            
            if [ -z "$N8N_CONTAINER" ]; then
              echo "‚úó n8n container not found"
              exit 1
            fi
            
            # Check n8n health
            if docker exec "$N8N_CONTAINER" wget --spider -q http://localhost:5678/healthz 2>/dev/null; then
              echo "‚úì n8n health check passed"
            else
              echo "‚úó n8n health check failed"
              exit 1
            fi
            
            echo "‚úì Deployment verification passed"
          ENDSSH

      - name: Notify on success
        if: success()
        run: |
          echo "üéâ Deployment to PRODUCTION completed successfully!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment to PRODUCTION failed!"
          echo "Check logs on VPS servers for details."
          exit 1
